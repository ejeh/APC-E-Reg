<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Certificate Details</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/index.js"></script>
    <style>
      .btn-secondary {
        color: white;
        background-color: #ff6175;
        border-color: #ff6175;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h2 class="card-title mb-0">Certificate Details</h2>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <strong>Name:</strong>
                <span id="certificate-name" class="text-muted">Loading...</span>
              </div>
              <div class="mb-3">
                <strong>Email:</strong>
                <span id="certificate-email" class="text-muted"
                  >Loading...</span
                >
              </div>
              <div class="mb-3">
                <strong>Phone:</strong>
                <span id="certificate-phone" class="text-muted"
                  >Loading...</span
                >
              </div>
              <div class="mb-3">
                <strong>Status:</strong>
                <span id="certificate-status" class="text-muted"
                  >Loading...</span
                >
              </div>
              <div class="mb-3">
                <strong>Issue Date:</strong>
                <span id="certificate-issue-date" class="text-muted"
                  >Loading...</span
                >
              </div>
              <div class="mb-3">
                <strong>Resubmissions:</strong>
                <span id="certificate-resubmissions" class="text-muted"
                  >Loading...</span
                >
              </div>
              <!-- <div class="d-grid gap-2">
                <a id="certificate-download" href="#" class="btn btn-success"
                  >Download Certificate</a
                >
              </div> -->
              <form id="upload-form" enctype="multipart/form-data">
                <input type="file" id="file" required />
                <button type="submit" class="btn btn-secondary">
                  Upload Attestation
                </button>
              </form>
              <div id="resubmit-container" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // Retrieve the token from localStorage
        let userData = localStorage.getItem("token");
        userData = JSON.parse(userData);
        const { token } = userData; // Destructure to get only the token

        // Extract certificateId from the URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const certificateId = urlParams.get("id");

        if (certificateId) {
          // Make the AJAX request
          $.ajax({
            url: `${BACKEND_URL}/indigene/certificate/${certificateId}/get`,
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            success: function (response) {
              // Check if the response contains data
              if (response && Object.keys(response).length > 0) {
                // Populate the certificate details
                $("#certificate-name").text(
                  `${response.firstname} ${response.lastname}`
                );
                $("#certificate-email").text(response.email);
                $("#certificate-phone").text(response.phone);
                $("#certificate-status").text(response.status);
                $("#certificate-issue-date").text(response.dateOfIssue);
                $("#certificate-resubmissions").text(
                  response.resubmissionAttempts
                );
                $("#certificate-download").attr("href", response.downloadLink);
              } else {
                console.error("Empty data received from the backend.");
                alert("No certificate data found.");
              }
            },
            error: function (xhr, status, error) {
              console.error(
                "Error fetching certificate details:",
                status,
                error
              );
              alert(
                "Failed to load certificate details. Please try again later."
              );
            },
          });
        } else {
          console.error("Certificate ID not found in URL.");
          alert("Certificate ID is missing in the URL.");
        }
      });
    </script>

    <script>
      // upload attestation
      document.addEventListener("DOMContentLoaded", function () {
        const uploadForm = document.getElementById("upload-form");
        const fileInput = document.getElementById("file");

        uploadForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Retrieve user authentication data
          const userData = JSON.parse(localStorage.getItem("token"));
          if (!userData?.token || !userData?.user?.id) {
            Swal.fire("Error", "User authentication failed!", "error");
            return;
          }

          // Fetch certificate ID dynamically
          try {
            const certResponse = await fetch(
              `${BACKEND_URL}/indigene/certificate/${userData.user.id}`,
              {
                method: "GET",
                headers: { Authorization: `Bearer ${userData.token}` },
              }
            );

            if (!certResponse.ok)
              throw new Error("Failed to retrieve certificate ID");

            const certData = await certResponse.json();
            const certificateId = certData._id;

            if (!certificateId) {
              Swal.fire("Error", "Certificate ID not found!", "error");
              return;
            }

            // Prepare file upload
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            // Upload attestation file
            const uploadResponse = await fetch(
              `${BACKEND_URL}/indigene/certificate/upload/attestation/${certificateId}`,
              {
                method: "POST",
                body: formData,
                headers: { Authorization: `Bearer ${userData.token}` },
              }
            );

            if (!uploadResponse.ok)
              throw new Error("Failed to upload attestation");

            Swal.fire(
              "Success",
              "Attestation uploaded! Await admin approval.",
              "success"
            );
          } catch (error) {
            console.error("Upload Error:", error);
            Swal.fire("Error", "An error occurred during upload.", "error");
          }
        });
      });
    </script>
    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>
    <!-- <script src="vendor/sweetalert2/dist/sweetalert2.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="/js/index.js"></script>
  </body>
</html>
